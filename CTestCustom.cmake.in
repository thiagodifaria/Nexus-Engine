# CTestCustom.cmake.in
# Custom CTest configuration for Nexus Trading Platform

# Exclude stress tests from Release configuration runs
# This ensures that `ctest --verbose -C Release` skips performance stress tests
if("@CMAKE_BUILD_TYPE@" STREQUAL "Release")
    set(CTEST_CUSTOM_TESTS_IGNORE
        test_performance_stress  # Exclude stress test from Release builds
    )
    
    message("CTest: Excluding stress tests from Release configuration")
endif()

# Set custom test timeout values
set(CTEST_CUSTOM_MAXIMUM_PASSED_TEST_OUTPUT_SIZE 1024)
set(CTEST_CUSTOM_MAXIMUM_FAILED_TEST_OUTPUT_SIZE 4096)

# Custom test timeout for different test categories
set(CTEST_CUSTOM_TEST_TIMEOUT 60)  # Default 1 minute timeout for unit tests

# Exclude specific tests based on labels in Release mode
if("@CMAKE_BUILD_TYPE@" STREQUAL "Release")
    # Exclude all tests with "stress" or "long_running" labels
    set(CTEST_CUSTOM_TESTS_IGNORE
        ${CTEST_CUSTOM_TESTS_IGNORE}
        # Any additional stress tests can be added here
    )
endif()

# Custom output formatting - Windows compatible
if(WIN32)
    # Use Windows-compatible commands or disable pre/post test commands
    set(CTEST_CUSTOM_PRE_TEST "")
    set(CTEST_CUSTOM_POST_TEST "")
else()
    # Unix/Linux systems can use echo
    set(CTEST_CUSTOM_PRE_TEST "echo 'Starting Nexus Trading Platform Tests...'")
    set(CTEST_CUSTOM_POST_TEST "echo 'Test execution completed.'")
endif()

# Memory and coverage options (when available)
set(CTEST_CUSTOM_MEMCHECK_IGNORE
    # Add any tests that should be ignored during memory checking
    test_performance_stress
)

# Build warning suppressions for cleaner output
set(CTEST_CUSTOM_WARNING_EXCEPTION
    "warning.*SQLite"  # Suppress SQLite-related warnings
    "warning.*pthread" # Suppress threading library warnings
    "warning C4324"    # Suppress MSVC structure padding warnings
    "warning C4189"    # Suppress MSVC unused variable warnings
    "warning C4100"    # Suppress MSVC unreferenced parameter warnings
)

# Coverage exclusions
set(CTEST_CUSTOM_COVERAGE_EXCLUDE
    ".*/tests/.*"      # Exclude test files from coverage
    ".*/third_party/.*" # Exclude third-party code
    ".*main.cpp"       # Exclude main function
)